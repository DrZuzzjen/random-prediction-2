# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Next.js 14** modern web application for a random prediction game where players try to predict random numbers generated by Random.org's true random number API. Players compete on a leaderboard and can view detailed analytics about their performance and global patterns.

**Note**: This is version 2.0 of the Random Prediction game, rebuilt with Next.js. The original Streamlit version is maintained separately at [random-prediction](https://github.com/DrZuzzjen/random-prediction).

### Core Architecture

- **Frontend**: Next.js 14 with App Router and React Server Components
- **Styling**: Custom CSS with safe dial/combination lock UI component
- **Database**: Supabase (PostgreSQL) with two main tables:
  - `leaderboard`: Stores user best scores and game counts
  - `game_runs`: Stores individual game data for analytics
- **External API**: Random.org JSON-RPC API for true random number generation
- **Analytics Engine**: Comprehensive pattern analysis and user statistics

### Key Components

1. **Game Page** (`app/(pages)/game/page.tsx`):
   - Interactive safe dial component for number selection
   - Multi-phase game flow: select → user details → results
   - Real-time leaderboard display
   - Session state management with React hooks

2. **Safe Dial Component** (`app/components/NumberDial.tsx`):
   - Custom-built combination lock-style number picker
   - Smooth rotation with mouse dragging and slider control
   - Counter-rotation for center text to keep it readable
   - Highlight markers for selected numbers

3. **Analytics Pages**:
   - **Global Analytics** (`app/(pages)/analytics/page.tsx`): Pattern analysis across all players
   - **User Analytics** (`app/(pages)/my-analytics/page.tsx`): Individual performance tracking

4. **API Routes**:
   - `/api/random`: Random.org number generation
   - `/api/game-run`: Save game results to database
   - `/api/leaderboard`: Fetch top players

5. **Database Schema**:
   - Primary schema in original repo: `scripts/database_setup.sql`
   - Analytics extensions: `scripts/database_analytics_schema.sql`
   - RLS policies for security

## Development Commands

### Setup and Installation
```bash
# Install dependencies
npm install

# Create .env file with required variables (see Environment Configuration)
```

### Running the Application
```bash
# Start development server
npm run dev

# Build for production
npm run build

# Start production server
npm start
```

### Linting
```bash
# Run ESLint
npm run lint
```

## Environment Configuration

Required environment variables (create `.env` file):
```env
# Random.org API
RANDOM_API_KEY=your_random_org_api_key

# Supabase Configuration
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

## Database Setup Process

1. Use the same Supabase database as the original Streamlit version
2. Schema is already set up if migrating from v1
3. No additional migrations needed - tables are compatible

## Key Data Structures

### Game Flow State Management
- Phase states: `'select'` → `'details'` → `'results'`
- React state: `selectedNumbers`, `randomNumbers`, `score`, `identity` (name/email)
- Cookie-based identity persistence using `useSavedIdentity` hook

### Safe Dial Mechanics
- 99 numbers (1-99)
- Rotation state with counter-rotation for center display
- Highlight markers for selected numbers
- Smooth transitions with CSS transforms

## Architecture Notes

### UI/UX Highlights
- **Safe Dial Component**: Custom-built combination lock interface
  - Rotates smoothly with mouse drag or slider
  - Center text stays upright (counter-rotation applied)
  - Visual indicators for selected numbers
  - No white artifacts or misaligned elements

### Performance Optimizations
- React Server Components for initial page loads
- Client-side interactivity where needed
- Efficient CSS transforms for dial rotation
- Cached database queries with `cache: "no-store"` where needed

### Security Considerations
- Row Level Security (RLS) enabled on all tables
- Email normalization (lowercase) to prevent duplicates
- Environment variable management for API keys
- API routes handle server-side operations only

### Game Rules and Fairness
- Both human predictions and Random.org numbers are unique (no duplicates)
- Random.org API configured with `replacement: false`
- Odds calculation for sampling without replacement
- Email normalization prevents user duplication

### Error Handling Patterns
- Graceful API failures with user-friendly status messages
- Network timeout handling for Random.org API
- Form validation with clear feedback
- Loading states during async operations

## Development Tips

- The safe dial uses counter-rotation: center element rotates by `-rotation` to cancel parent rotation
- All transforms must include both `translate()` and `rotate()` to maintain positioning
- CSS `.safe-dial-handle` is hidden with `display: none` for cleaner appearance
- Test rotation behavior with both mouse dragging and slider control
- Check responsive behavior on mobile devices

## Component Architecture

### Safe Dial (`NumberDial.tsx`)
- Parent `.safe-dial-face` rotates with user interaction
- Child `.safe-dial-ring` contains tick marks and number labels
- Child `.safe-dial-center` applies counter-rotation to stay upright
- Inline styles override CSS for dynamic rotation values

### Styling Structure (`globals.css`)
- Custom CSS properties with `--dial-size` for responsive sizing
- Transform chains for positioning and rotation
- Radial gradients for depth and 3D effect
- Responsive breakpoints for mobile optimization

## Version History

- **v2.0** (Next.js): Modern web app with interactive UI
- **v1.0** (Streamlit): Original Python-based version

## MCP Server Configuration

**Note**: MCP configuration must be in global Claude config
- Global config: `~/.claude/mcp.json`
- Need to restart Claude Code session after config changes
